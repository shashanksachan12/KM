<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>KMRL Fleet Management</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    /* âœ… START: Standard Navbar & Theme CSS */
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --surface-color: #ffffff;
        --bg-color: #f3f4f6;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --border-color: #e5e7eb;
        --radius-lg: 12px;
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }
    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-primary);
        margin: 0;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; }
    
    .header { background: #1e3a8a; color: #fff; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow-md); }
    .header-container { display: flex; align-items: center; padding: 1rem 2rem; }
    .header-nav { display: flex; align-items: center; gap: 0.5rem; }
    .logo { margin-right: 1.5rem; }
    .logo img { height: 40px; }
    .nav-item, .dropdown-toggle, .notification-btn, .profile-btn {
        display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; color: #fff;
        text-decoration: none; border-radius: 6px; transition: background-color 0.2s;
        background: transparent; border: none; font-family: inherit; font-size: 1rem; cursor: pointer;
    }
    .nav-item.active, .nav-item:hover, .dropdown-toggle:hover, .notification-btn:hover, .profile-btn:hover { background-color: rgba(255, 255, 255, 0.15); }
    .nav-dropdown, .notification-container, .profile-container { position: relative; }
    .nav-dropdown-content {
        display: none; position: absolute; top: 120%; left: 0; background-color: var(--surface-color);
        border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 0.5rem; z-index: 1001;
        min-width: 200px; border: 1px solid var(--border-color);
    }
    .nav-dropdown.active .nav-dropdown-content { display: block; }
    .nav-dropdown-item {
        color: var(--text-primary); padding: 0.75rem 1rem; display: flex; align-items: center;
        gap: 0.75rem; text-decoration: none; border-radius: 6px;
    }
    .nav-dropdown-item:hover { background-color: var(--bg-color); }
    .header-right { margin-left: auto; display: flex; align-items: center; gap: 0.5rem; }
    
    .notification-badge {
        position: absolute; top: 5px; right: 10px; background-color: #ef4444; color: white;
        width: 18px; height: 18px; border-radius: 50%; font-size: 0.7rem; font-weight: bold;
        display: flex; align-items: center; justify-content: center; border: 2px solid #1e3a8a;
    }
    .profile-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: -0.25rem; object-fit: cover; }
    .notification-dropdown, .profile-dropdown {
        display: none; position: absolute; top: 120%; right: 0; background-color: var(--surface-color);
        color: var(--text-primary); border-radius: var(--radius-lg); box-shadow: var(--shadow-md);
        width: 320px; z-index: 1001; border: 1px solid var(--border-color);
    }
    .notification-container.active .notification-dropdown, .profile-container.active .profile-dropdown { display: block; }
    .notification-header, .profile-info { padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .notification-list { max-height: 300px; overflow-y: auto; }
    .notification-item { display: flex; gap: 1rem; padding: 1rem; }
    .notification-item:hover { background-color: var(--bg-color); }
    .notification-title { font-weight: 600; margin-bottom: 0.25rem; }
    .notification-text, .profile-details p { font-size: 0.9rem; color: var(--text-secondary); margin: 0; }
    .notification-time { font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem; }
    .profile-info { gap: 1rem; }
    .profile-avatar-large { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
    .profile-details h4 { margin: 0; }
    .profile-menu button {
        display: flex; width: 100%; text-align: left; padding: 0.75rem 1rem; gap: 0.75rem; 
        color: var(--text-primary); border-radius: 0; font-size: 1rem;
    }
    .profile-menu button:hover { background-color: var(--bg-color); }
    .profile-menu-divider { height: 1px; background-color: var(--border-color); margin: 0.5rem 0; }
    .main-content { padding: 2rem 0; }
    .page-header { margin-bottom: 2rem; }
    .page-header h1 { font-size: 2.25rem; margin: 0; }
    .page-header p { color: var(--text-secondary); margin-top: 0.25rem; }
    /* âœ… END: Standard CSS */

    /* âœ… START: Page-Specific Fleet Management CSS */
    .card {
        background: var(--surface-color);
        padding: 30px 35px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
    }
    form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 25px;
    }
    label { font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: var(--text-secondary); display: block; }
    input, select {
        padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color); outline: none;
        font-size: 1rem; font-family: 'Poppins', sans-serif; width: 100%; box-sizing: border-box;
    }
    form button {
        grid-column: 1 / -1; padding: 15px; border: none; border-radius: 8px;
        background: linear-gradient(45deg, #1d4ed8, var(--primary-color));
        color: #fff; font-size: 1.1rem; font-weight: 700; cursor: pointer;
        transition: transform 0.2s;
    }
    form button:hover { transform: translateY(-2px); }
    #results { display: none; }
    .fleet-status {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;
        margin-bottom: 25px; text-align: center;
    }
    .status-item { background: #f7f9fc; padding: 15px; border-radius: 10px; border: 1px solid #e0e8f3; }
    .status-item h4 { margin: 0 0 5px 0; font-size: 1rem; color: #555; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .status-item p { margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--primary-color);}
    .status-item p.positive { color: #27ae60; }
    .status-item p.negative { color: #e74c3c; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    table th, table td { border: 1px solid var(--border-color); padding: 12px; text-align: center; }
    table th { background: var(--primary-color); color: #fff; }
    .shortfall { background-color: #ffefef; color: #c00; font-weight: bold; }
    #metro-map {
        position: relative; width: 100%; height: 220px; background: #2c3e50;
        border-radius: var(--radius-lg); overflow: hidden; box-shadow: inset 0 4px 15px rgba(0,0,0,0.3);
        padding: 20px 0; box-sizing: border-box;
    }
    .track { position: relative; height: 6px; border-radius: 3px; width: calc(100% - 100px); margin: 35px 50px; }
    #line1 { background: #3498db; }
    #line2 { background: #2ecc71; }
    #line3 { background: #e67e22; }
    .rake {
        position: absolute; width: 40px; height: 20px; border-radius: 4px; display: flex;
        justify-content: center; align-items: center; font-size: 11px; font-weight: bold;
        color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); transform: translateX(0px); left: 50px;
    }
    .brake-indicator {
        position: absolute; width: 10px; height: 16px; background: #e74c3c;
        border: 1px solid #c0392b; border-radius: 2px; left: 50px; transform: translateY(-5px);
        opacity: 0; transition: opacity 0.3s ease; z-index: 10;
    }
    .signal-light {
        position: absolute; right: 30px; width: 16px; height: 16px; background-color: #333;
        border-radius: 50%; border: 2px solid #444; transition: background-color 0.3s, box-shadow 0.3s;
    }
    .signal-light.green.active { background-color: #2ecc71; box-shadow: 0 0 12px #2ecc71; }
    .signal-light.red.active { animation: blink-red 1.2s infinite ease-in-out; }
    @keyframes blink-red { 0%, 100% { background-color: #e74c3c; box-shadow: 0 0 12px #e74c3c; } 50% { background-color: #8c2318; box-shadow: 0 0 12px transparent; } }
    /* âœ… END: Page-Specific CSS */
  </style>
</head>
<body>
    <header class="header">
      <div class="container header-container">
        <nav class="header-nav">
          <div class="logo">
            <img src="logo.jpg" alt="Kochi Metro Logo" />
          </div>
          <a href="dashboard.html" class="nav-item"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
          <div class="nav-dropdown">
            <button class="nav-item dropdown-toggle"><i class="fas fa-cogs"></i><span>Operations</span><i class="fas fa-chevron-down dropdown-arrow"></i></button>
            <div class="nav-dropdown-content">
              <a href="train-operations.html" class="nav-dropdown-item"><i class="fas fa-train"></i><span>Train Operations</span></a>
              <a href="verify-operations.html" class="nav-dropdown-item"><i class="fas fa-check-circle"></i><span>Verify Operations</span></a>
            </div>
          </div>
          <a href="management.html" class="nav-item"><i class="fas fa-users-cog"></i><span>Management</span></a>
          <a href="staff-management.html" class="nav-item"><i class="fas fa-users"></i><span>Staff</span></a>
          <a href="schedule-management.html" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Schedule</span></a>
          <a href="live-map.html" class="nav-item"><i class="fas fa-map-marked-alt"></i><span>Live Map</span></a>
          <a href="reports1.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
          <a href="multitrack.html" class="nav-item"><i class="fas fa-route"></i><span>Multitrack</span></a>
          <a href="finance-department.html" class="nav-item"><i class="fas fa-money-bill-wave"></i><span>Finance</span></a>
        </nav>
      
    </header>
    
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1>ðŸš‡ Kochi Metro Fleet Management</h1>
                <p>Predict passenger demand and simulate rake deployment in real-time.</p>
            </div>

            <div class="card">
              <form id="predictForm">
                <div class="form-group">
                  <label for="dow">Day of Week (0-6)</label>
                  <input type="number" id="dow" value="3" min="0" max="6" required>
                </div>
                <div class="form-group">
                  <label for="month">Month (1-12)</label>
                  <input type="number" id="month" value="9" min="1" max="12" required>
                </div>
                <div class="form-group">
                  <label for="is_weekend">Weekend</label>
                  <select id="is_weekend"><option value="0">No</option><option value="1">Yes</option></select>
                </div>
                <div class="form-group">
                  <label for="is_holiday">Holiday</label>
                  <select id="is_holiday"><option value="0">No</option><option value="1">Yes</option></select>
                </div>
                <div class="form-group">
                  <label for="special_event">Special Event</label>
                  <select id="special_event"><option value="0">No</option><option value="1">Yes</option></select>
                </div>
                <div class="form-group">
                  <label for="temp">Temperature (Â°C)</label>
                  <input type="number" id="temp" value="28" step="0.1" required>
                </div>
                <button type="submit">Predict & Deploy Rakes</button>
              </form>
            </div>

            <div id="results" class="card"></div>

            <div id="metro-map" class="card">
              <div id="line1" class="track"></div>
              <div id="line2" class="track"></div>
              <div id="line3" class="track"></div>
            </div>
        </div>
    </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Navbar Dropdown Logic ---
    const dropdownTriggers = [
        { selector: '.dropdown-toggle', container: '.nav-dropdown' },
        { selector: '#notification-btn', container: '.notification-container' },
        { selector: '#profile-btn', container: '.profile-container' }
    ];
    dropdownTriggers.forEach(triggerInfo => {
        document.querySelectorAll(triggerInfo.selector).forEach(trigger => {
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                const container = trigger.closest(triggerInfo.container);
                const isActive = container.classList.contains('active');
                document.querySelectorAll('.nav-dropdown, .notification-container, .profile-container').forEach(d => d.classList.remove('active'));
                if (!isActive) {
                    container.classList.add('active');
                }
            });
        });
    });
    window.addEventListener('click', (e) => {
        if (!e.target.closest('.nav-dropdown, .notification-container, .profile-container')) {
            document.querySelectorAll('.nav-dropdown, .notification-container, .profile-container').forEach(d => d.classList.remove('active'));
        }
    });

    // --- Fleet Management Logic ---
    const TOTAL_FLEET_SIZE = 40; // âœ… Total fleet size set to 40 as requested.
    const RAKE_WIDTH = 40;
    const STOPPING_GAP = 12;
    const MAX_LOOPS = 1; 
    const INITIAL_SPEED = 2.5;
    
    let activeRakes = [];
    let trackStates = {};
    let animationFrameId = null;

    function calculatePredictions(data) {
        let { dow, is_weekend, is_holiday, special_event, temp } = data;
        let line1 = 5, line2 = 4, line3 = 4;
        if (is_weekend) { line1 += 3; line2 += 2; line3 += 2; }
        if (is_holiday) { line1 += 2; line2 += 3; line3 += 3; }
        if (special_event) { line1 += 2; line2 += 3; line3 += 4; }
        if (temp > 35) { line1 = Math.max(1, line1 - 1); line2 = Math.max(1, line2 - 1); }
        return { Line1: line1, Line2: line2, Line3: line3 };
    }

    document.getElementById("predictForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const data = {
            dow: parseInt(document.getElementById("dow").value),
            month: parseInt(document.getElementById("month").value),
            is_weekend: parseInt(document.getElementById("is_weekend").value),
            is_holiday: parseInt(document.getElementById("is_holiday").value),
            special_event: parseInt(document.getElementById("special_event").value),
            temp: parseFloat(document.getElementById("temp").value)
        };
        
        const predictions = calculatePredictions(data);
        const totalDemand = predictions.Line1 + predictions.Line2 + predictions.Line3;
        const maintenanceRakes = Math.floor(Math.random() * 2) + 1;
        const availableFleet = TOTAL_FLEET_SIZE - maintenanceRakes;
        const reserveOrShortfall = availableFleet - totalDemand;
        
        let deployedRakes = {};
        if (totalDemand <= availableFleet) {
            deployedRakes = predictions;
        } else {
            let remainingToDeploy = availableFleet;
            deployedRakes.Line1 = Math.min(predictions.Line1, remainingToDeploy);
            remainingToDeploy -= deployedRakes.Line1;
            deployedRakes.Line2 = Math.min(predictions.Line2, remainingToDeploy);
            remainingToDeploy -= deployedRakes.Line2;
            deployedRakes.Line3 = Math.min(predictions.Line3, remainingToDeploy);
        }
        const totalDeployed = Object.values(deployedRakes).reduce((sum, val) => sum + val, 0);
        
        displayResults({
            totalDemand, totalDeployed, reserveOrShortfall, predictions,
            deployedRakes, maintenanceRakes
        });
        
        prepareAndStartAnimation(deployedRakes);
    });
    
    function displayResults(data) {
        const resultsBox = document.getElementById("results");
        resultsBox.style.display = "block";
        const { totalDemand, totalDeployed, reserveOrShortfall, predictions, deployedRakes, maintenanceRakes } = data;
        const shortfallStatus = reserveOrShortfall < 0 ? 'Shortfall' : 'Reserve';
        const shortfallClass = reserveOrShortfall < 0 ? 'negative' : 'positive';
        
        resultsBox.innerHTML = `
            <h3>Fleet Status</h3>
            <div class="fleet-status">
                <div class="status-item"><h4><i class="fas fa-train"></i> Total Fleet</h4><p>${TOTAL_FLEET_SIZE}</p></div>
                <div class="status-item"><h4><i class="fas fa-tools"></i> Maintenance</h4><p class="negative">${maintenanceRakes}</p></div>
                <div class="status-item"><h4><i class="fas fa-chart-line"></i> Predicted Demand</h4><p>${totalDemand}</p></div>
                <div class="status-item"><h4><i class="fas fa-rocket"></i> Total Deployed</h4><p>${totalDeployed}</p></div>
                <div class="status-item"><h4><i class="fas fa-balance-scale"></i> ${shortfallStatus}</h4><p class="${shortfallClass}">${Math.abs(reserveOrShortfall)}</p></div>
            </div>
            <h3>Deployment Details</h3>
            <table>
                <tr><th>Line</th><th>Predicted Demand</th><th>Rakes Deployed</th></tr>
                ${Object.keys(predictions).map(line => `
                    <tr class="${(deployedRakes[line] || 0) < predictions[line] ? 'shortfall' : ''}">
                        <td>${line}</td>
                        <td>${predictions[line]}</td>
                        <td>${deployedRakes[line] || 0}</td>
                    </tr>
                `).join('')}
            </table>`;
    }

    function prepareAndStartAnimation(deployedRakes) {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        document.querySelectorAll(".rake, .brake-indicator, .signal-light").forEach(el => el.remove());
        activeRakes = [];
        trackStates = {};
        const trackInfo = {
            Line1: { top: 35, color: '#3498db' },
            Line2: { top: 95, color: '#2ecc71' },
            Line3: { top: 155, color: '#e67e22' }
        };
        for (const line in deployedRakes) {
            if (!trackInfo[line] || deployedRakes[line] === 0) continue; 
            const count = deployedRakes[line];
            const brakeIndicatorEl = document.createElement('div');
            brakeIndicatorEl.className = 'brake-indicator';
            brakeIndicatorEl.style.top = (trackInfo[line].top) + 'px';
            document.getElementById('metro-map').appendChild(brakeIndicatorEl);
            
            const signalLightEl = document.createElement('div');
            signalLightEl.className = 'signal-light green active';
            signalLightEl.style.top = (trackInfo[line].top - 5) + 'px';
            document.getElementById('metro-map').appendChild(signalLightEl);

            trackStates[line] = { 
                brakeIndicatorEl, 
                signalLight: signalLightEl,
                isRed: false,
                allReadyForFinalRun: false
            };
            
            const spacing = (document.getElementById('metro-map').clientWidth - 100) / Math.max(count, 1);
            for (let i = 0; i < count; i++) {
                const rakeEl = document.createElement("div");
                rakeEl.className = "rake";
                rakeEl.style.background = trackInfo[line].color;
                rakeEl.style.top = (trackInfo[line].top) + "px";
                rakeEl.textContent = i + 1;
                document.getElementById("metro-map").appendChild(rakeEl);
                activeRakes.push({
                    element: rakeEl, line: line, index: i,
                    initialPosition: -RAKE_WIDTH - i * spacing, 
                    position: -RAKE_WIDTH - i * spacing,
                    speed: INITIAL_SPEED, isBraking: false, isStopped: false,
                    loopCount: 0, maxLoops: MAX_LOOPS
                });
            }
        }
        animationLoop();
    }

    function animationLoop() {
        if (!activeRakes.length) return;
        let allStopped = true;
        const trackWidth = document.getElementById('metro-map').clientWidth - 100;
        const rakesByLine = activeRakes.reduce((acc, rake) => {
            if (!acc[rake.line]) acc[rake.line] = [];
            acc[rake.line][rake.index] = rake;
            return acc;
        }, {});
        for (const line in rakesByLine) {
            const lineState = trackStates[line];
            if (!lineState.allReadyForFinalRun) {
                lineState.allReadyForFinalRun = rakesByLine[line].every(r => r.loopCount >= MAX_LOOPS);
            }
        }
        for (const rake of activeRakes) {
            if (rake.isStopped) continue;
            allStopped = false;
            const lineState = trackStates[rake.line];
            if (lineState.allReadyForFinalRun) {
                const trainInFront = rakesByLine[rake.line][rake.index - 1];
                let targetPosition;
                if (!trainInFront) {
                    targetPosition = trackWidth - RAKE_WIDTH;
                    if (!lineState.isRed) {
                        lineState.signalLight.classList.remove('green');
                        lineState.signalLight.classList.add('red', 'active');
                        lineState.brakeIndicatorEl.style.opacity = '1';
                        lineState.isRed = true;
                    }
                    lineState.brakeIndicatorEl.style.transform = `translateY(-5px) translateX(${targetPosition}px)`;
                } else {
                    targetPosition = trainInFront.position - RAKE_WIDTH - STOPPING_GAP;
                }
                if (rake.position > targetPosition - 150 && !rake.isBraking) {
                    rake.isBraking = true;
                }
                if (rake.isBraking) {
                    rake.speed *= 0.95;
                }
                if (rake.position >= targetPosition) {
                    rake.position = targetPosition;
                    if (trainInFront && !trainInFront.isStopped) {
                        rake.speed = trainInFront.speed;
                    } else {
                        rake.speed = 0;
                        rake.isStopped = true;
                    }
                }
            } else {
                if (rake.position > trackWidth + RAKE_WIDTH) {
                    if (rake.loopCount < rake.maxLoops) {
                        rake.loopCount++;
                        rake.position = rake.initialPosition;
                    }
                }
            }
            rake.position += rake.speed;
            rake.element.style.transform = `translateX(${rake.position}px)`;
        }
        if (!allStopped) {
            animationFrameId = requestAnimationFrame(animationLoop);
        }
    }
});
</script>
</body>
</html>